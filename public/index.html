<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–®—É—Ç–∫–∏ —Å —Ä–µ–∞–∫—Ü–∏—è–º–∏</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <button onclick="toggleTheme()" class="theme-toggle">üåì</button>

  <div class="container">
    <h1>–õ—É—á—à–∏–µ —à—É—Ç–∫–∏</h1>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ —à—É—Ç–∫–∞–º..." oninput="loadJokes()" />
      <select id="sortSelect" onchange="loadJokes()">
        <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
        <option value="popular">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
        <option value="controversial">–°–ø–æ—Ä–Ω—ã–µ</option>
      </select>
      <select id="categorySelect" onchange="loadJokes()">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      </select>
      <input type="text" id="tagFilter" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º..." oninput="loadJokes()" />
      <label class="media-filter">
        <input type="checkbox" id="mediaOnly" onchange="loadJokes()" /> –¢–æ–ª—å–∫–æ —Å –º–µ–¥–∏–∞
      </label>
    </div>

    <form id="jokeForm">
      <input type="text" id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è" required />
      <textarea id="jokeText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ—é —à—É—Ç–∫—É..." required maxlength="500"></textarea>
      <input type="text" id="mediaUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/–≤–∏–¥–µ–æ/–∞—É–¥–∏–æ/–∞—Ä—Ö–∏–≤" oninput="showMediaPreview(this.value)" />
      <input type="file" id="videoInput" accept=".mp4,.mp3,.zip,.rar,.7z,.webm,.ogg" onchange="uploadVideo()" />
      <input type="text" id="tagInput" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" />
      <div class="media-preview" id="mediaPreview"></div>
      <button type="submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </form>

    <div class="loader" id="loader"></div>
    <div id="jokesContainer" class="jokes-container"></div>
    <div class="pagination">
      <button onclick="changePage(-1)">‚Üê –ù–∞–∑–∞–¥</button>
      <span id="currentPage">1</span>
      <button onclick="changePage(1)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    </div>
    <div id="notification" class="notification"></div>
  </div>

  <script>
    let isLoading = false;
    let currentPage = 1;
    const PAGE_SIZE = 10;

    const loader = document.getElementById('loader');
    const notification = document.getElementById('notification');

    const showNotification = (message, isError = false) => {
      notification.textContent = message;
      notification.className = `notification ${isError ? 'error' : ''} show`;
      setTimeout(() => notification.classList.remove('show'), 3000);
    };

    async function uploadVideo() {
      const fileInput = document.getElementById('videoInput');
      const file = fileInput.files[0];
      if (!file) {
        showNotification('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω', true);
        return;
      }

      const formData = new FormData();
      formData.append('video', file);

      try {
        const res = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('mediaUrl').value = data.url;
          showMediaPreview(data.url);
        } else {
          showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', true);
        }
      } catch (err) {
        showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', true);
      }
    }

    function changePage(delta) {
      currentPage += delta;
      if (currentPage < 1) currentPage = 1;
      document.getElementById('currentPage').textContent = currentPage;
      loadJokes();
    }

    const isValidMediaUrl = (url) => {
      const allowedExtensions = [
        '.mp4', '.webm', '.ogg', '.mp3', '.wav', '.zip', '.rar', '.7z', '.tar', '.gz', '.png', '.jpg', '.jpeg', '.gif', '.webp'
      ];
      return /^https?:\/\//.test(url) || /^\/upload\//.test(url) || allowedExtensions.some(ext => url.toLowerCase().endsWith(ext));
    };

    function renderMedia(url) {
      const ext = url.split('.').pop().toLowerCase();
      if (['mp4', 'webm', 'ogg'].includes(ext)) {
        return `<div class="media-container">
                  <video controls><source src="${url}" type="video/${ext}">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.</video>
                </div>`;
      }
      if (['mp3', 'wav'].includes(ext)) {
        return `<div class="media-container">
                  <audio controls><source src="${url}" type="audio/${ext}">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.</audio>
                </div>`;
      }
      if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) {
        return `<div class="media-container">
                  <a href="${url}" download class="archive-link">üì¶ –°–∫–∞—á–∞—Ç—å –∞—Ä—Ö–∏–≤</a>
                </div>`;
      }
      return `<div class="media-container"><img src="${url}" alt=""></div>`;
    }

    function showMediaPreview(url) {
      const preview = document.getElementById('mediaPreview');
      preview.innerHTML = url && isValidMediaUrl(url) ? renderMedia(url) : '';
    }

    async function loadJokes() {
      if (isLoading) return;
      isLoading = true;
      loader.style.display = 'block';

      try {
        const params = new URLSearchParams({
          sort: document.getElementById('sortSelect').value,
          mediaOnly: document.getElementById('mediaOnly').checked,
          search: document.getElementById('searchInput').value,
          category: document.getElementById('categorySelect').value,
          tag: document.getElementById('tagFilter').value.trim().toLowerCase(),
          page: currentPage,
          limit: PAGE_SIZE
        });

        const response = await fetch(`/api/jokes?${params}`);
        const jokes = await response.json();
        renderJokes(jokes);
      } catch (err) {
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à—É—Ç–æ–∫', true);
      } finally {
        isLoading = false;
        loader.style.display = 'none';
      }
    }

    document.getElementById('jokeForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('usernameInput').value.trim();
      const text = document.getElementById('jokeText').value.trim();
      const media = document.getElementById('mediaUrl').value.trim();
      const tags = document.getElementById('tagInput').value
        .split(',')
        .map(tag => tag.trim().toLowerCase())
        .filter(Boolean);

      if (!name) return showNotification('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è', true);
      if (!text) return showNotification('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —à—É—Ç–∫–∏', true);
      if (media && !isValidMediaUrl(media)) return showNotification('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –º–µ–¥–∏–∞', true);

      try {
        const res = await fetch('/api/jokes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name, text, media, tags })
        });
        if (res.ok) {
          document.getElementById('jokeForm').reset();
          document.getElementById('mediaPreview').innerHTML = '';
          showNotification('–®—É—Ç–∫–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!');
          loadJokes();
        }
      } catch {
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —à—É—Ç–∫–∏', true);
      }
    });

    function renderJokes(jokes) {
      const container = document.getElementById('jokesContainer');
      container.innerHTML = jokes.map(joke => `
        <div class="joke-card" data-id="${joke.id}">
          <p class="joke-text">${joke.text}</p>
          ${joke.media ? renderMedia(joke.media) : ''}
          <div class="joke-footer">
            <div class="reactions">
              <button class="like-btn ${joke.userVote === 'like' ? 'active' : ''}" onclick="handleVote(${joke.id}, 'like')">üëç <span>${joke.likes}</span></button>
              <button class="dislike-btn ${joke.userVote === 'dislike' ? 'active' : ''}" onclick="handleVote(${joke.id}, 'dislike')">üëé <span>${joke.dislikes}</span></button>
            </div>
            <span class="joke-date">${new Date(joke.date).toLocaleDateString('ru-RU')}</span>
          </div>
          <div class="comments">
            <input type="text" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." onkeydown="submitComment(event, ${joke.id})">
            <div class="comment-list" id="comments-${joke.id}">
              ${joke.comments?.map(c => `<p>${c.text}</p>`).join('') || ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    async function handleVote(jokeId, voteType) {
      const card = document.querySelector(`.joke-card[data-id="${jokeId}"]`);
      const likeBtn = card.querySelector('.like-btn');
      const dislikeBtn = card.querySelector('.dislike-btn');

      try {
        const res = await fetch(`/api/jokes/${jokeId}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ voteType }),
          credentials: 'include'
        });
        if (res.ok) {
          const data = await res.json();
          likeBtn.querySelector('span').textContent = data.likes;
          dislikeBtn.querySelector('span').textContent = data.dislikes;
          likeBtn.classList.toggle('active', data.userVote === 'like');
          dislikeBtn.classList.toggle('active', data.userVote === 'dislike');
        }
      } catch {
        showNotification('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è', true);
      }
    }

    async function submitComment(e, id) {
      if (e.key !== 'Enter') return;
      const text = e.target.value.trim();
      if (!text) return;

      const res = await fetch(`/api/jokes/${id}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ text })
      });

      if (res.ok) {
        const comment = await res.json();
        const container = document.getElementById(`comments-${id}`);
        container.innerHTML += `<p>${comment.text}</p>`;
        e.target.value = '';
      } else {
        showNotification('–û—à–∏–±–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', true);
      }
    }

    async function loadCategories() {
      const res = await fetch('/api/categories');
      const cats = await res.json();
      const select = document.getElementById('categorySelect');
      cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
    }

    function toggleTheme() {
      const isDark = document.body.dataset.theme === 'dark';
      document.body.dataset.theme = isDark ? 'light' : 'dark';
      localStorage.setItem('theme', document.body.dataset.theme);
    }

    function init() {
      document.body.dataset.theme = localStorage.getItem('theme') || 'light';
      loadCategories();
      loadJokes();
    }

    init();
  </script>
</body>
</html>